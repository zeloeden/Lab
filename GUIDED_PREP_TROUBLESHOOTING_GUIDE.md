# Guided Preparation - Troubleshooting Guide

## üéØ Issues Fixed

### ‚úÖ Issue 1: "Waiting zero..." Fixed!

**Problem**: Even though scale showed "0.000 g" and "Stable", it still said "Waiting zero..."

**Root Cause**: The preparation wizard was using the **OLD** `WeighPanel` component that doesn't understand the **NEW** stable weight system.

**Solution**: ‚úÖ Replaced `WeighPanel` with `WeighPanelStable`

**What You'll See Now**:
- ‚úÖ "Scale Connected" ‚Üí Green dot
- ‚úÖ "Stable" ‚Üí Green with solid dot
- ‚úÖ "Zero OK" ‚Üí Green (not "Waiting zero...")
- ‚úÖ Confirm button enabled when stable

---

## üîç Issue 2: QR Code Not Recognized - Diagnosis Guide

### Why QR Scans Might Fail

Your system has **THREE different QR code formats**:

#### Format 1: **New Unified Format** (Recommended)
```
NBS:RM;id=sample-123;code=MAT001;name=Musk AL Tahara;ver=1
```
Generated by: `src/lib/qr/generator.ts` ‚Üí `generateMaterialCodes()`

#### Format 2: **Old Simple Format**
```
S:sample-123
```
Generated by: `src/lib/qrGenerator.ts` ‚Üí `generateSampleQR()`

#### Format 3: **Formula Format**
```
F:formula-456
```

### How to Debug QR Scan Issues

**Step 1: Open Browser DevTools** (Press F12)

**Step 2: Look for Debug Logs**

When you scan, you should see in the console:

```
[DEBUG] Built validCodes for Musk AL Tahara: [
  "RM:sample-123",
  "sample-123",
  "S:MAT001",
  "MAT001",
  "barcode-value"
]
```

This shows **all the codes that will be accepted** for this ingredient.

**Step 3: Scan the QR**

You should see:
```
[CodeInput] Using registry validation for material: sample-123
[CodeInput] Checking payload: NBS:RM;id=sample-456;code=MAT002;...
[CodeInput] Registry match result: false
```

**Step 4: Compare**

If the IDs don't match (`123` vs `456`), **that's your problem!**

---

## üêõ Common QR Mismatch Scenarios

### Scenario 1: Wrong Sample QR
**Problem**: You scanned a QR for "Rose Oil" but the step expects "Musk AL Tahara"

**Solution**: Scan the **correct** ingredient's QR code

### Scenario 2: QR Has Wrong ID
**Problem**: 
- Step expects: `sample-123`
- QR contains: `sample-456`

**Why This Happens**:
- Old QR codes from before seed
- Manual edits to sample IDs
- Multiple QR generations

**Solution**: Regenerate QR codes after seeding

### Scenario 3: QR Format Not Recognized
**Problem**: QR uses format the registry doesn't understand

**Solution**: Use the **unified format** (`NBS:RM;...`)

---

## ‚úÖ How to Fix QR Recognition Issues

### Quick Fix: Use the Correct QR Code

1. **Go to Raw Materials** or **Samples** page
2. **Find the ingredient** (e.g., "Musk AL Tahara")
3. **Look for the QR code** displayed on the card
4. **Print that QR** or display it on screen
5. **Scan THAT specific QR** during preparation

### Better Fix: Regenerate All QR Codes

If you've seeded data, regenerate QR codes:

1. **Open sample** in Samples page
2. **Edit and save** (triggers QR regeneration)
3. **New QR will match** the sample ID

---

## üîß Advanced Debugging

### Check What's Expected

**In browser console**, when prep step loads:
```javascript
// Check what the step expects
console.log(step.material);  // The actual sample object
console.log(step.altCodes);  // All accepted codes
```

### Check What's Scanned

**When scanning**, the console shows:
```javascript
[CodeInput] Checking payload: "NBS:RM;id=xxx;..."
```

### Manual Test

**In browser console:**
```javascript
// Test if a QR payload matches
import { tokenMatchesMaterial } from '@/lib/scan/registry';

// The material from the step
const material = { id: 'sample-123', code: 'MAT001', name: 'Musk' };

// What you scanned
const scanned = 'NBS:RM;id=sample-123;code=MAT001;name=Musk;ver=1';

// Test
tokenMatchesMaterial(scanned, material);  // Should return true
```

---

## üìã Complete Test Checklist

### Test 1: Scale Zero Detection ‚úÖ
1. ‚úÖ Refresh browser (F5)
2. ‚úÖ Start preparation
3. ‚úÖ Check scale status shows: "Scale Connected" + "Stable" + "Zero OK"
4. ‚úÖ Verify "Confirm Step" button is disabled (nothing scanned yet)

### Test 2: QR Code Scan
1. ‚è≥ Open DevTools (F12) ‚Üí Console tab
2. ‚è≥ Scan QR code
3. ‚è≥ Look for debug logs:
   ```
   [DEBUG] Built validCodes for Musk AL Tahara: [...]
   [CodeInput] Checking payload: ...
   [CodeInput] Registry match result: true/false
   ```
4. ‚è≥ If `result: true` ‚Üí Code should unlock
5. ‚è≥ If `result: false` ‚Üí IDs don't match (see logs)

### Test 3: Weight Measurement
1. ‚è≥ After scanning, place container on scale
2. ‚è≥ Watch status change: Stable ‚Üí Live ‚Üí Stable
3. ‚è≥ When weight is within tolerance, button enables
4. ‚è≥ Click "Confirm Step"

---

## üéì Understanding the System

### The Scan Registry (`src/lib/scan/registry.ts`)

**What it does**: Central database of **all** valid scan codes for each material

**How it works**:
1. Builds a map of **every possible scan code** ‚Üí material ID
2. When you scan, it normalizes the input
3. Looks up the material by the scanned code
4. Returns true if found, false if not

**What it accepts**:
- Sample IDs: `sample-123`, `RM:sample-123`
- Codes: `MAT001`, `S:MAT001`
- Barcodes: from `barcodes[]` array
- QR payloads: `NBS:RM;id=123;...`
- Custom aliases: from `scanAliases[]`

### The Stable Weight System

**Bridge** (`simple_bridge.js`):
- Analyzes weight packets
- Computes stability (spread ‚â§ 0.002g over 1 second)
- Sends: `{type:"weight", value:6.778, unit:"g", stable:true}`

**Frontend** (`useScaleWS` hook):
- Receives packets
- Tracks `rawWeight` (every frame)
- Updates `displayWeight` (only when stable or big jump)
- Provides status: `'live' | 'stable' | 'idle'`

**WeighPanelStable** component:
- Shows big display weight
- Shows live hint when not stable
- Only enables "Confirm" when truly stable
- No flicker, smooth transitions

---

## üö® Common Mistakes

### ‚ùå Mistake 1: Scanning Random QR Code
**Wrong**: Scan a formula QR when step expects raw material
**Right**: Scan the **specific ingredient's QR**

### ‚ùå Mistake 2: Using Old QR After Seed
**Wrong**: Use QR generated before running seed
**Right**: Regenerate QR codes after seed

### ‚ùå Mistake 3: Expecting Instant Zero
**Wrong**: Scale must instantly show "Zero OK"
**Right**: Scale needs ~1 second to stabilize and confirm zero

---

## üìû Still Not Working?

### Share These Logs

Open DevTools (F12) ‚Üí Console, and share:

1. **When step loads:**
   ```
   [DEBUG] Built validCodes for XXX: [...]
   ```

2. **When scanning:**
   ```
   [CodeInput] Checking payload: ...
   [CodeInput] Registry match result: ...
   ```

3. **Material object:**
   ```javascript
   console.log(step.material);
   ```

This will show exactly why the scan is failing!

---

**Status**: ‚úÖ Scale zero detection fixed  
**Status**: ‚è≥ QR scan - needs debugging with real data  
**Date**: 2024-10-20

